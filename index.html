<!--
Vecto Mapping System - Refactored
Version: 5.0 (Feature: Display Optimized Route Order in Details)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vecto - Dark</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;400;500;600;700&display=swap" rel="stylesheet">

    <!-- === CSS STYLES (styles.css) START === -->
    <style>
        /* Base & Reset */
        body { font-family: 'Inter', sans-serif; }
        
        /* Map Containers */
        #map, #public-map, #public-driver-map { height: 100%; width: 100%; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Button States */
        button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Google Places Autocomplete Customization */
        .pac-container {
            background-color: #1f2937;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10005 !important;
            font-family: 'Inter', sans-serif;
        }
        .pac-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #d1d5db;
            border-top: 1px solid #374151;
        }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: #374151; }
        .pac-item-query { color: #f9fafb; font-weight: 500; }
        .pac-matched { color: #60a5fa; }

        /* Animations & Loaders */
        .spinner {
            display: inline-block;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 1rem;
            height: 1rem;
            animation: spin 1s ease-in-out infinite;
        }
        .large-spinner {
             width: 3rem;
             height: 3rem;
             border-width: 4px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pulse-border {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(156, 163, 175, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(156, 163, 175, 0); }
            100% { box-shadow: 0 0 0 0 rgba(156, 163, 175, 0); }
        }

        /* Tabs */
        .tab-btn.active {
            border-bottom-color: #0d9488; /* teal-600 */
            color: #e5e7eb; /* gray-200 */
        }

        /* Selected Job Card Highlight */
        li.selected-job-card {
            border-color: #0d9488 !important; /* teal-600 */
            background-color: #374151 !important; /* gray-700 */
        }

        /* Input Highlighting */
        .soft-teal-glow {
            box-shadow: 0 0 10px rgba(45, 212, 191, 0.4); /* teal-400 with opacity */
            border-color: #2dd4bf !important; /* teal-400 */
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #job-details-printable, #job-details-printable * { visibility: visible; }
            #job-details-printable {
                position: absolute; left: 0; top: 0; width: 100%;
                background-color: white; color: black;
            }
            #job-details-modal > div { max-height: none !important; }
            #job-details-printable h3, 
            #job-details-printable strong, 
            #job-details-printable p, 
            #job-details-printable span, 
            #job-details-printable li, 
            .creator-tag-print { color: black !important; }
            
            #job-details-printable button, 
            #job-details-printable form { display: none; }
            
            #job-chat-box {
                border: 1px solid #ccc;
                height: auto !important;
                overflow-y: visible !important;
            }
            #job-chat-box .chat-message {
                background-color: transparent !important;
                padding: 2px 0 !important;
                border-bottom: 1px dotted #ccc;
            }
            #job-chat-box .chat-message > div { background: none !important; }
            #job-chat-box .chat-message p { color: black !important; }
        }
    </style>
    <!-- === CSS STYLES END === -->
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- === HTML STRUCTURE START === -->
    
    <!-- System Overlays -->
    <div id="offline-banner" class="hidden fixed top-0 left-0 right-0 bg-yellow-600 text-white text-center p-2 z-[10002]">
        You are currently offline. Data may not be up-to-date.
    </div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-[10001]">
        <div class="text-center">
            <div class="spinner large-spinner mx-auto"></div>
            <p class="text-gray-400 mt-4">Connecting to Vecto...</p>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 right-4 z-[10000]"></div>

    <!-- View: Authentication -->
    <div id="auth-container" class="hidden flex items-center justify-center h-screen">
        <div class="w-full max-w-sm text-center">
             <h1 class="text-4xl font-bold text-white mb-2">Vecto</h1>
             <p class="text-gray-400 mb-8">Please sign in to continue</p>
             <button id="google-signin-btn" class="bg-white text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-200 flex items-center justify-center w-full">
                 <!-- Google Icon SVG -->
                 <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                 Sign in with Google
             </button>
        </div>
    </div>

    <!-- View: Main Application -->
    <div id="app-container" class="hidden flex flex-col md:flex-row md:h-screen">
        <!-- Map Panel -->
        <div id="map-container" class="w-full md:w-2/3 h-96 md:h-full">
            <div id="map" class="rounded-lg shadow-md bg-gray-700 flex items-center justify-center">
                <p class="text-gray-400">Loading Map...</p>
            </div>
        </div>

        <!-- Sidebar Panel -->
        <div class="w-full md:w-1/3 md:h-full flex flex-col bg-gray-800 p-4 space-y-4 overflow-y-auto border-l-2 border-teal-600">
            <div id="sidebar-content" class="flex flex-col h-full relative">
                <!-- Sidebar Loader -->
                <div id="sidebar-loader" class="absolute inset-0 bg-gray-800 bg-opacity-75 flex-col items-center justify-center z-10 hidden">
                    <div class="spinner large-spinner"></div>
                    <p class="text-gray-300 mt-4">Loading Company Data...</p>
                </div>

                <!-- Header -->
                <div>
                    <div class="flex items-center justify-between pb-2 border-b border-gray-700">
                        <h1 class="text-2xl font-bold text-white">Vecto</h1>
                        <div class="flex items-center space-x-4">
                            <button id="settings-btn" class="text-gray-400 hover:text-white" title="Settings">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </button>
                            <button id="logout-btn" class="text-sm text-red-400 hover:text-red-300">Logout</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-2">
                        <div class="flex items-center space-x-2">
                            <h2 id="user-welcome" class="text-lg font-semibold text-gray-200">Welcome!</h2>
                            <span id="admin-badge" class="hidden bg-indigo-600 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full">Admin</span>
                        </div>
                    </div>
                    
                    <div id="company-selection-panel" class="bg-gray-900 p-4 rounded-lg shadow-sm mt-4">
                        <button id="select-company-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <span id="select-company-btn-label" class="text-[1.5rem] leading-snug underline font-semibold">Select/Change Company</span>
                        </button>
                    </div>

                    <!-- Dispatcher Specific UI -->
                    <div id="dispatch-ui" class="hidden">
                        <div id="management-actions-panel" class="bg-gray-900 p-4 rounded-lg shadow-sm mt-4">
                            <div class="grid grid-cols-1 gap-2">
                                <button id="open-create-job-modal-btn" class="w-full px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Create Job</button>
                            </div>
                        </div>
                        <div id="job-dashboard-panel" class="bg-gray-900 p-4 rounded-lg shadow-sm mt-4">
                            <div class="flex border-b border-gray-700">
                                <button data-tab="current" class="tab-btn flex-1 py-2 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:border-gray-500 hover:text-gray-300 active">Current</button>
                                <button data-tab="archive" class="tab-btn flex-1 py-2 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:border-gray-500 hover:text-gray-300">Archive</button>
                            </div>
                            <div class="mt-4 space-y-2">
                                <input type="text" id="job-search-input" placeholder="Search jobs..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <ul id="jobs-list" class="space-y-2 mt-4"></ul>
                        </div>
                        <div id="drivers-panel" class="bg-gray-900 p-4 rounded-lg shadow-sm mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-200">Drivers</h3>
                                <button id="refresh-drivers-btn" class="p-1 rounded-full hover:bg-gray-700" title="Refresh List">
                                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                                </button>
                            </div>
                            <ul id="drivers-list" class="space-y-2"></ul>
                        </div>
                    </div>

                    <!-- Driver Specific UI -->
                    <div id="driver-ui" class="hidden">
                        <div id="current-job-panel" class="hidden bg-blue-900 border border-blue-700 p-4 rounded-lg shadow-sm mt-4 cursor-pointer">
                            <h3 class="text-lg font-semibold text-white mb-2">My Current Job</h3>
                            <div id="current-job-details" class="text-sm text-blue-200 space-y-1"></div>
                            <div class="grid grid-cols-2 gap-2 mt-3">
                                <button id="start-navigation-btn" class="w-full px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Navigate</button>
                                <button id="complete-job-btn" class="w-full px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">Complete</button>
                            </div>
                             <button id="arrived-btn" class="hidden w-full mt-3 px-4 py-2 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 animate-pulse">Arrived? Mark as Complete</button>
                        </div>
                        <div id="available-jobs-panel" class="bg-gray-900 p-4 rounded-lg shadow-sm mt-4">
                            <h3 class="text-lg font-semibold text-gray-200 mb-2">Open Job Postings</h3>
                            <ul id="available-jobs-list" class="space-y-2"></ul>
                        </div>
                        <div id="driver-status-panel" class="bg-gray-900 p-4 rounded-lg shadow-sm mt-4">
                            <h2 class="text-lg font-semibold text-gray-200 mb-2">My Status</h2>
                            <div id="driver-status-control" class="space-y-2">
                                <label for="driver-status-select" class="block text-sm font-medium text-gray-300">Current Status:</label>
                                <select id="driver-status-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md text-white">
                                    <option>Available</option>
                                    <option>On Break</option>
                                </select>
                                <button id="share-location-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Share Location</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-auto pt-4 text-center text-xs font-thin text-gray-500">
                    <p>Vecto</p>
                    <p>Wolfe.BT@TangentLLC</p>
                </div>
            </div>
        </div>
    </div>

    <!-- View: Public Job Tracking -->
    <div id="public-job-container" class="hidden flex flex-col md:flex-row md:h-screen">
        <div id="public-map-container" class="w-full md:w-2/3 h-96 md:h-full">
            <div id="public-map" class="rounded-lg shadow-md bg-gray-700 flex items-center justify-center h-full w-full">
                <p class="text-gray-400">Loading Map...</p>
            </div>
        </div>
        <div class="w-full md:w-1/3 md:h-full flex flex-col bg-gray-800 p-4 space-y-4 overflow-y-auto border-l-2 border-teal-600">
            <h1 class="text-2xl font-bold text-white pb-2 border-b border-gray-700">Live Job Tracking</h1>
            <div id="public-job-details" class="bg-gray-900 p-4 rounded-lg shadow-sm space-y-2 text-gray-300"></div>
        </div>
    </div>

    <!-- View: Public Driver Tracking -->
    <div id="public-driver-container" class="hidden flex flex-col md:flex-row md:h-screen">
        <div id="public-driver-map-container" class="w-full md:w-2/3 h-96 md:h-full">
            <div id="public-driver-map" class="rounded-lg shadow-md bg-gray-700 flex items-center justify-center h-full w-full">
                <p class="text-gray-400">Loading Map...</p>
            </div>
        </div>
        <div class="w-full md:w-1/3 md:h-full flex flex-col bg-gray-800 p-4 space-y-4 overflow-y-auto border-l-2 border-indigo-600">
            <h1 class="text-2xl font-bold text-white pb-2 border-b border-gray-700">Live Driver Tracking</h1>
            <div id="public-driver-details" class="bg-gray-900 p-4 rounded-lg shadow-sm space-y-2 text-gray-300"></div>
        </div>
    </div>

    <!-- === MODALS === -->
    
    <!-- Modal: Location Sharing -->
    <div id="location-share-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10001]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-4">Share My Location</h3>
            <p class="text-sm text-gray-400 mb-4">Share a temporary link to your live location.</p>
            <div class="space-y-3">
                <input type="text" id="location-share-destination" placeholder="Enter a destination (optional)" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                <div class="flex space-x-2">
                    <button id="set-personal-route-btn" class="w-full px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Set Route</button>
                    <button id="clear-personal-route-btn" class="hidden w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Clear Route</button>
                </div>
                <div id="personal-route-info" class="text-sm text-gray-300 hidden">
                    <p><strong>ETA:</strong> <span id="personal-route-eta">--</span></p>
                    <p><strong>Distance:</strong> <span id="personal-route-distance">--</span></p>
                </div>
            </div>
            <div id="location-share-details" class="mt-4 pt-4 border-t border-gray-600 space-y-4">
                <div class="flex space-x-2">
                    <input type="text" id="location-share-url" readonly class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <button id="copy-location-share-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Copy</button>
                </div>
                <div class="text-center">
                    <p class="text-gray-400 mb-2">Or scan QR Code</p>
                    <div id="location-share-qrcode" class="flex justify-center p-2 bg-white rounded-lg w-36 h-36 mx-auto"></div>
                </div>
            </div>
            <button id="location-share-close-btn" class="mt-6 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Close</button>
        </div>
    </div>

    <!-- Modal: Select Company -->
    <div id="company-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10004]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-6">Select or Create Company</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="text-lg font-semibold text-gray-200 mb-2">Join Existing Company</h4>
                    <ul id="company-list" class="space-y-2 max-h-48 overflow-y-auto"></ul>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <h4 class="text-lg font-semibold text-gray-200 mb-2">Create New Company</h4>
                    <form id="create-company-form" class="space-y-2">
                        <input type="text" id="new-company-name" placeholder="Company Name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                        <input type="password" id="new-company-password" placeholder="Company Password (optional)" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                        <button type="submit" class="w-full px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Create & Join</button>
                    </form>
                </div>
            </div>
            <button id="company-cancel-btn" class="mt-8 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Close</button>
        </div>
    </div>

    <!-- Modal: Company Password -->
    <div id="company-password-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10005]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <form id="company-password-form">
                <h3 id="company-password-title" class="text-xl font-bold text-white mb-4">Enter Password</h3>
                <input type="password" id="company-password-input" placeholder="Company Password" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" id="company-password-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Join</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Invite -->
    <div id="invite-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10004]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-6">Invite Others</h3>
            <div class="space-y-6">
                <div class="text-center">
                    <p class="text-gray-400 mb-2">Scan QR Code</p>
                    <div id="qrcode" class="flex justify-center p-2 bg-white rounded-lg"></div>
                </div>
                <div>
                    <p class="text-gray-400 mb-2">Or share this link:</p>
                    <div class="flex space-x-2">
                        <input type="text" id="share-link-input" readonly class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <button id="copy-link-btn" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Copy</button>
                    </div>
                </div>
            </div>
            <button id="invite-cancel-btn" class="mt-8 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Close</button>
        </div>
    </div>

    <!-- Modal: User Guide -->
    <div id="user-guide-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10004]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 flex flex-col" style="max-height: 90vh;">
            <h3 class="text-2xl font-bold text-white mb-4">Vecto User Guide</h3>
            <div class="overflow-y-auto text-gray-300 space-y-4">
                <p>Welcome to Vecto! Use the map to track your fleet and the sidebar to manage jobs.</p>
                <p><strong>Dispatchers:</strong> Create jobs, track drivers, and manage users.</p>
                <p><strong>Drivers:</strong> Accept jobs, navigate, and mark deliveries as complete.</p>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-700 flex justify-end">
                <button id="user-guide-close-btn" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Comment/POD -->
    <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10003]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <form id="comment-form">
                <h3 id="comment-modal-title" class="text-xl font-bold text-white mb-4">Add Comment</h3>
                <textarea id="comment-input" placeholder="Enter your comment..." rows="4" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <div class="mt-4">
                    <label for="pod-upload" class="block text-sm font-medium text-gray-300">Add Photo (Proof of Delivery)</label>
                    <input type="file" id="pod-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" id="comment-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Profile -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <form id="profile-form">
                <h3 class="text-xl font-bold text-white mb-4">Edit Profile</h3>
                <div class="space-y-4">
                    <input type="text" id="profile-name-input" placeholder="Your Name" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="tel" id="profile-phone-input" placeholder="Mobile Number" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" id="profile-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Create/Edit Job -->
    <div id="create-job-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <form id="create-job-form">
                <h3 id="create-job-modal-title" class="text-xl font-bold text-white mb-4">Create New Job</h3>
                <input type="hidden" id="editing-job-id">
                <div class="space-y-4">
                    <input type="text" id="job-name-input" placeholder="Job Name" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                    <div>
                        <label for="job-date-input" class="block text-sm font-medium text-gray-300">Job Date:</label>
                        <input type="date" id="job-date-input" required class="w-full mt-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                    </div>
                    <input type="text" id="job-origin-input" placeholder="Job Origin" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                    
                    <div id="destinations-container" class="space-y-2"></div>
                    <button type="button" id="add-destination-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Add Destination</button>
                    
                    <div id="optimize-route-container" class="hidden items-center">
                        <input id="optimize-route-checkbox" type="checkbox" class="h-4 w-4 text-teal-600 bg-gray-700 border-gray-600 rounded focus:ring-teal-500">
                        <label for="optimize-route-checkbox" class="ml-2 block text-sm text-gray-300">Optimize Route</label>
                    </div>

                    <input type="text" id="contact-name-input" placeholder="Contact Name" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                    <input type="tel" id="contact-number-input" placeholder="Contact Number" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                    <textarea id="job-note-input" placeholder="Job Notes (optional)" rows="2" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400"></textarea>
                    
                     <div>
                        <label for="assign-driver-select" class="block text-sm font-medium text-gray-300">Assign Driver (optional):</label>
                        <select id="assign-driver-select" class="w-full mt-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Post as open job</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" id="create-job-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
                        <button type="submit" id="create-job-submit-btn" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 flex items-center justify-center w-32">
                            <span class="btn-text">Add</span>
                            <span class="spinner hidden ml-2"></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirm Action -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10002]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirm-modal-message" class="text-gray-300 mb-4"></p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancel</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modal: Job Details -->
    <div id="job-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4 flex flex-col" style="max-height: 90vh;">
            <div id="job-details-printable" class="overflow-y-auto flex-grow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-white">Job Details</h3>
                </div>
                <div id="job-details-content" class="text-gray-300 space-y-2"></div>
                <div id="pod-section" class="mt-4 hidden">
                    <h4 class="text-lg font-semibold text-white mb-2">Proof of Delivery</h4>
                    <img id="pod-image" src="" alt="Proof of Delivery" class="rounded-lg max-w-full h-auto">
                </div>
                <div id="driver-completion-comment-section" class="mt-4 hidden">
                    <h4 class="text-lg font-semibold text-white mb-2">Driver's Comment</h4>
                    <p id="driver-completion-comment" class="text-sm text-gray-400 italic p-2 border border-gray-700 rounded-md"></p>
                </div>
                <div id="dispatcher-closing-comment-section" class="mt-4 hidden">
                    <h4 class="text-lg font-semibold text-white mb-2">Dispatcher's Closing</h4>
                    <p id="dispatcher-closing-comment" class="text-sm text-gray-400 italic p-2 border border-gray-700 rounded-md"></p>
                </div>
                <div class="mt-4">
                    <h4 class="text-lg font-semibold text-white mb-2">History</h4>
                    <ul id="job-history-log" class="space-y-1 text-sm text-gray-400"></ul>
                </div>
                <div id="tracking-link-section" class="mt-4 pt-4 border-t border-gray-700">
                    <h4 class="text-lg font-semibold text-white mb-2">Tracking Link</h4>
                    <div id="tracking-link-container"></div>
                </div>
                 <div class="mt-4">
                    <h4 class="text-lg font-semibold text-white mb-2">Messages</h4>
                    <div id="job-chat-box" class="h-40 border border-gray-700 rounded-md p-2 overflow-y-auto"></div>
                    <form id="job-chat-form" class="mt-2 flex space-x-2">
                        <input type="text" id="job-chat-input" placeholder="Type a message..." class="flex-grow px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Send</button>
                    </form>
                </div>
                <div class="creator-tag-print pt-4 mt-4 border-t border-gray-300 text-center text-xs font-thin">
                    <p>Vecto</p>
                    <p>Wolfe.BT@TangentLLC</p>
                </div>
            </div>
            <div id="job-details-driver-actions" class="hidden mt-4">
                <button id="job-details-accept-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Accept Job</button>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-700 flex justify-between items-center flex-shrink-0 space-x-2">
                <div class="flex-grow flex justify-end space-x-2">
                    <button id="finalize-job-btn" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Finalize Job</button>
                    <button id="edit-job-btn" class="hidden px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Edit</button>
                    <button id="archive-job-btn" class="hidden px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Archive</button>
                    <button id="unarchive-job-modal-btn" class="hidden px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Unarchive</button>
                    <button id="print-job-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Print</button>
                    <button id="delete-job-btn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
                    <button id="job-details-driver-cancel-btn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Cancel</button>
                    <button id="job-details-close-btn" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Tracking Link -->
    <div id="tracking-link-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10001]">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-4">Tracking Link</h3>
            <form id="tracking-link-form" class="space-y-4">
                <p class="text-sm text-gray-400">Create a real-time tracking link.</p>
                <button type="submit" id="generate-tracking-link-btn" class="w-full px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Generate Link</button>
            </form>
            <div id="tracking-link-details" class="hidden mt-4 space-y-4">
                <div class="flex space-x-2">
                    <input type="text" id="tracking-link-url" readonly class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <button id="copy-tracking-link-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Copy</button>
                </div>
                <div class="text-center">
                    <p class="text-gray-400 mb-2">QR Code</p>
                    <div id="tracking-link-qrcode" class="flex justify-center p-2 bg-white rounded-lg w-36 h-36 mx-auto"></div>
                </div>
            </div>
            <button id="tracking-link-close-btn" class="mt-6 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Close</button>
        </div>
    </div>

    <!-- Modal: Admin Settings -->
    <div id="admin-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 overflow-y-auto" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">User Role Management</h3>
                <button id="refresh-user-roles-btn" class="p-1 rounded-full hover:bg-gray-700" title="Refresh List">
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                </button>
            </div>
            <div id="settings-content" class="space-y-4">
                 <ul id="user-role-list" class="space-y-4"></ul>
            </div>
             <button id="admin-settings-cancel-btn" class="mt-6 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Close</button>
        </div>
    </div>

    <!-- Modal: Settings Menu -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-white mb-6">Settings</h3>
            <div class="space-y-4">
                <button id="open-profile-modal-btn" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">Edit Profile</button>
                <button id="open-user-guide-btn" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600">User Guide</button>
                <button id="open-invite-modal-btn" class="w-full px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">Invite Others</button>
                <div id="admin-controls" class="hidden pt-4 border-t border-gray-700">
                     <button id="open-admin-settings-btn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Admin: User Roles</button>
                </div>
                
                <!-- NEW: API Key Section -->
                <div class="border-t border-gray-700 pt-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Google Maps API Key</label>
                    <input type="text" id="custom-api-key-input" placeholder="Enter your API Key" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 text-sm mb-2">
                    <button id="save-api-key-btn" class="w-full px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Save & Reload</button>
                    <p class="text-xs text-gray-500 mt-1">Leave empty to use default (if available).</p>
                </div>

            </div>
            <button id="settings-cancel-btn" class="mt-6 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Close</button>
        </div>
    </div>

    <!-- === JAVASCRIPT (script.js) START === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, serverTimestamp, GeoPoint, deleteDoc, query, where, getDocs, updateDoc, writeBatch, getDoc, arrayUnion, arrayRemove, runTransaction, enableIndexedDbPersistence, initializeFirestore, persistentLocalCache, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIG & UTILS ---
        const CONSTANTS = {
            MAPS_API_KEY: "", // REMOVED: User must provide their own key
            FIREBASE_CONFIG: {
                apiKey: "AIzaSyBGro7OUoAC1xXaBo8JjLnOQSFjZCmdoBI",
                authDomain: "route-tracker-e62b1.firebaseapp.com",
                projectId: "route-tracker-e62b1",
                storageBucket: "route-tracker-e62b1.appspot.com",
                messagingSenderId: "1016000331711",
                appId: "1:1016000331711:web:a122b8a52045ee4e832b0a",
                measurementId: "G-B476Z21SKP"
            }
        };

        // --- STATE MANAGEMENT ---
        const AppState = {
            currentUser: null,
            isAuthReady: false,
            companyId: null,
            companyName: null,
            map: null,
            publicMap: null,
            publicDriverMap: null,
            userMarker: null,
            driverMapMarkers: {},
            isSharingLocation: false,
            locationWatchId: null,
            allUsers: [],
            allJobs: [],
            activeDrivers: [],
            activeJobTab: 'current',
            isDispatchView: false,
            selectedJobId: null,
            optimizedRoutes: {}, // NEW: Store optimized route orders here
            callbacks: {
                confirm: null,
                comment: null
            },
            paths: { globalUsers: '', companies: '', publicJobs: '', publicDrivers: '', members: '', drivers: '', jobs: '' },
            services: { auth: null, db: null, storage: null, directions: null },
            maps: { jobRouteRenderers: {}, jobColors: {}, personalRouteRenderer: null },
            colors: ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A133FF', '#33FFA1', '#FFC300', '#C70039'],
            unsubscribes: { global: [], company: [], chat: null },
            ui: { autocomplete: [], currentJobIdModal: null, passwordJoinId: null }
        };

        const Utils = {
            formatDuration(totalSeconds) {
                if (isNaN(totalSeconds) || totalSeconds < 0) return 'N/A';
                const days = Math.floor(totalSeconds / 86400);
                const hours = Math.floor((totalSeconds % 86400) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                let result = '';
                if (days > 0) result += `${days}d `;
                if (hours > 0) result += `${hours}h `;
                if (minutes > 0 || (days === 0 && hours === 0)) result += `${minutes}m`;
                return result.trim();
            },
            getJobColor(jobId) {
                if (!AppState.maps.jobColors[jobId]) {
                    const colorIndex = Object.keys(AppState.maps.jobColors).length % AppState.colors.length;
                    AppState.maps.jobColors[jobId] = AppState.colors[colorIndex];
                }
                return AppState.maps.jobColors[jobId];
            },
            checkPermission(permission) {
                return AppState.currentUser?.permissions?.[permission] === true;
            },
            generateInviteLink() {
                const baseUrl = window.location.href.split('?')[0];
                return `${baseUrl}?companyId=${AppState.companyId}`;
            }
        };

        // --- UI MODULE ---
        const UI = {
            els: {}, // Cache DOM elements here
            
            init() {
                // Bulk cache common elements
                const ids = [
                    'loading-overlay', 'auth-container', 'app-container', 'sidebar-loader',
                    'jobs-list', 'drivers-list', 'available-jobs-list', 'company-list',
                    'company-modal', 'job-details-modal', 'create-job-modal', 'settings-modal',
                    'confirm-modal', 'comment-modal', 'location-share-modal',
                    'dispatch-ui', 'driver-ui', 'user-welcome', 'select-company-btn-label',
                    'admin-badge', 'admin-controls', 'management-actions-panel', 'offline-banner',
                    'user-role-list', 'job-details-content'
                ];
                ids.forEach(id => this.els[id] = document.getElementById(id));
            },

            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `p-4 mb-2 rounded-md shadow-lg text-white ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            toggleSpinner(btn, show) {
                const spinner = btn.querySelector('.spinner');
                const text = btn.querySelector('.btn-text');
                if (spinner && text) {
                    spinner.classList.toggle('hidden', !show);
                    text.classList.toggle('hidden', show);
                }
                btn.disabled = show;
            },

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.remove('hidden');
                // Feature: Auto-apply highlights to inputs in the opened modal
                UI.setupInputHighlights(modalId);
            },

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('hidden');
            },
            
            // --- Feature: Input Highlighting ---
            setupInputHighlights(containerId) {
                 const container = document.getElementById(containerId);
                 if (!container) return;
                 
                 // Apply initial state immediately
                 UI.refreshFormHighlights(containerId);
                 
                 // Ensure we don't attach duplicate listeners
                 if (!container.dataset.highlightsAttached) {
                     container.addEventListener('input', (e) => {
                         if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                             if (e.target.value.trim() === '') {
                                 e.target.classList.add('soft-teal-glow');
                             } else {
                                 e.target.classList.remove('soft-teal-glow');
                             }
                         }
                     });
                     container.dataset.highlightsAttached = "true";
                 }
            },

            refreshFormHighlights(formId) {
                 const form = document.getElementById(formId);
                 if (!form) return;
                 const inputs = form.querySelectorAll('input:not([type="hidden"]), textarea, select');
                 inputs.forEach(input => {
                     if (input.value.trim() === '') {
                         input.classList.add('soft-teal-glow');
                     } else {
                         input.classList.remove('soft-teal-glow');
                     }
                 });
            },

            // --- NEW: Specific Update for Selection ---
            updateSelection() {
                 const list = document.getElementById('jobs-list');
                 const items = list.getElementsByTagName('li');
                 for (let item of items) {
                     if (item.dataset.jobId === AppState.selectedJobId) {
                         item.classList.add('selected-job-card');
                         item.classList.remove('border-transparent');
                     } else {
                         item.classList.remove('selected-job-card');
                     }
                 }
            },

            renderJobsList() {
                const listEl = this.els['jobs-list'];
                const isArchived = AppState.activeJobTab === 'archive';
                const searchTerm = document.getElementById('job-search-input').value.toLowerCase();
                
                let jobs = AppState.allJobs.filter(job => !!job.archived === isArchived);
                if (searchTerm) {
                    jobs = jobs.filter(job => 
                        (job.jobName || '').toLowerCase().includes(searchTerm) ||
                        (job.origin || '').toLowerCase().includes(searchTerm) ||
                        (job.destinations && job.destinations.some(d => d.toLowerCase().includes(searchTerm)))
                    );
                }
                jobs.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                listEl.innerHTML = jobs.length === 0 ? `<li class="text-gray-400 text-sm">No jobs found.</li>` : '';
                
                jobs.forEach(job => {
                    const li = document.createElement('li');
                    li.dataset.jobId = job.id;
                    const color = Utils.getJobColor(job.id);
                    let statusClass = 'bg-gray-800 hover:bg-gray-700';
                    let borderColor = 'border-transparent';
                    let statusTag = '';

                    // Status Logic
                    if (isArchived) {
                        statusTag = `<span class="px-2 py-1 bg-gray-600 text-xs rounded-full">Archived</span>`;
                    } else if (job.status === 'pending-completion') {
                        statusClass = 'bg-green-900 hover:bg-green-800';
                        statusTag = `<span class="px-2 py-1 bg-green-600 text-xs rounded-full">Pending</span>`;
                    } else if (job.status === 'in-progress') {
                        li.style.borderColor = color;
                        statusTag = `<span class="px-2 py-1 bg-blue-600 text-xs rounded-full">In Progress</span>`;
                    } else if (job.status === 'completed') {
                        borderColor = 'border-gray-600';
                        statusTag = `<span class="px-2 py-1 bg-gray-600 text-xs rounded-full">Completed</span>`;
                    } else if (job.status === 'unassigned') {
                        statusTag = `<span class="px-2 py-1 bg-yellow-600 text-xs rounded-full">Available</span>`;
                    }

                    // Pulse effect for new messages
                    if (job.lastMessageTimestamp && AppState.currentUser && 
                        job.lastMessageTimestamp.toMillis() > (AppState.currentUser.lastRead?.[job.id] || 0)) {
                        li.classList.add('pulse-border');
                    }
                    
                    // Selected State - Add class if selected
                    if (AppState.selectedJobId === job.id) {
                        li.classList.add('selected-job-card');
                        borderColor = ''; // Let CSS handle it
                    }

                    li.className = `p-3 rounded-md text-sm cursor-pointer border-l-4 ${statusClass} ${borderColor} ${AppState.selectedJobId === job.id ? 'selected-job-card' : ''}`;
                    const assigned = (job.assignedDrivers || []).map(d => d.name).join(', ');
                    const dest = job.destinations && job.destinations.length > 0 
                        ? (job.destinations.length > 1 ? `${job.destinations.length} stops` : job.destinations[0]) 
                        : (job.destination || 'N/A');

                    li.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-bold text-white">${job.jobName || 'Unnamed'}</p>
                            ${statusTag}
                        </div>
                        <p class="text-gray-400"><strong class="text-gray-200">From:</strong> ${job.origin}</p>
                        <p class="text-gray-400"><strong class="text-gray-200">To:</strong> ${dest}</p>
                        <p class="text-gray-400"><strong class="text-gray-200">Drivers:</strong> ${assigned || 'Unassigned'} (${(job.assignedDrivers||[]).length}/${job.driversNeeded})</p>
                        <div id="job-eta-info-${job.id}" class="text-xs text-gray-300 mt-1"></div>
                    `;
                    listEl.appendChild(li);
                });
            },

            renderDriversList() {
                const listEl = this.els['drivers-list'];
                listEl.innerHTML = '';
                const fiveMinAgo = Date.now() - (5 * 60 * 1000);
                const active = AppState.activeDrivers.filter(d => d.timestamp && d.timestamp.toMillis() > fiveMinAgo);

                if (active.length === 0) {
                    listEl.innerHTML = '<li class="text-gray-400 text-sm">No active drivers.</li>';
                    return;
                }

                active.forEach(driver => {
                    const user = AppState.allUsers.find(u => u.id === driver.id);
                    let statusText = driver.status || 'Online';
                    let statusColor = 'bg-gray-500';
                    
                    const assignedJob = AppState.allJobs.find(j => j.status === 'in-progress' && j.assignedDrivers.some(d => d.id === driver.id));
                    if (assignedJob) {
                        statusText = `On Trip: ${assignedJob.jobName}`;
                        statusColor = 'bg-yellow-500';
                    } else if (driver.status === 'Available') statusColor = 'bg-green-500';
                    
                    const li = document.createElement('li');
                    li.className = `flex justify-between items-center bg-gray-800 p-2 rounded-md border-l-4 border-green-500`;
                    li.innerHTML = `
                        <div>
                            <p class="text-sm font-bold text-gray-200">${driver.name || 'Unnamed'}</p>
                            <p class="text-xs text-gray-400">ETA: ${driver.eta || 'N/A'}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-semibold text-gray-400 mr-2">${statusText}</span>
                            <span class="w-3 h-3 rounded-full ${statusColor}"></span>
                            ${Utils.checkPermission('canManageDrivers') ? `
                                <button data-driver-id="${driver.id}" class="remove-driver-btn p-1 hover:bg-red-800 rounded-full">
                                    <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>` : ''}
                        </div>
                    `;
                    listEl.appendChild(li);
                });
            },

            // --- RESTORED LOGIC ---
            renderUserRoles() {
                const listEl = this.els['user-role-list'];
                listEl.innerHTML = '';
                const permissions = ['canCreateJob', 'canDeleteJob', 'canManageDrivers'];
                
                AppState.allUsers.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700 p-3 rounded relative mb-2';
                    
                    const isCurrentUser = user.id === AppState.currentUser.id;
                    const deleteBtn = !isCurrentUser ? 
                        `<button data-user-id="${user.id}" class="delete-user-btn p-1 rounded-full hover:bg-red-800 absolute top-2 right-2 text-red-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>` : '';

                    const checks = permissions.map(p => {
                        const checked = user.permissions?.[p] ? 'checked' : '';
                        return `<label class="flex items-center space-x-2">
                            <input type="checkbox" data-uid="${user.id}" data-perm="${p}" class="perm-check bg-gray-600 border-gray-500 rounded" ${checked} ${isCurrentUser ? 'disabled' : ''}>
                            <span class="text-xs text-gray-300">${p}</span>
                        </label>`;
                    }).join('');

                    li.innerHTML = `<p class="font-bold text-sm text-gray-200 mb-2">${user.name || user.email}</p>${deleteBtn}<div class="grid grid-cols-2 gap-2">${checks}</div>`;
                    listEl.appendChild(li);
                });
            }
        };

        // --- MAPS MODULE ---
        const Maps = {
            async init(elementId = 'map') {
                // Feature: Check localStorage for custom API Key
                const userKey = localStorage.getItem('vecto_maps_api_key');
                const apiKey = userKey || CONSTANTS.MAPS_API_KEY;

                // Feature: Handle Missing Key Gracefully
                if (!apiKey) {
                     const mapEl = document.getElementById(elementId);
                     if(mapEl) mapEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-4 text-center">
                        <p class="text-yellow-400 font-bold mb-2">Google Maps API Key Required</p>
                        <p class="text-gray-400 text-sm mb-4">Please set your API key in Settings to view the map.</p>
                        <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Open Settings</button>
                     </div>`;
                     return;
                }

                // Global callback for JSONP loading
                window.initMap = () => {
                    console.log("Map callback invoked");
                    this.loadMapComponents(elementId);
                };

                // Feature: Robust Loading with Callback (Standard Method)
                if (!window.google || !window.google.maps) {
                    const script = document.createElement("script");
                    // Using "callback=initMap" ensures we wait for full load
                    // "loading=async" is modern best practice
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&v=weekly&libraries=places&loading=async&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    script.onerror = () => {
                        console.error("Script load error");
                        if(window.gm_authFailure) window.gm_authFailure();
                    };
                    document.head.appendChild(script);
                } else {
                    this.loadMapComponents(elementId);
                }
            },

            loadMapComponents(elementId) {
                // STUB DETECTION: If key is invalid, google.maps exists but Map constructor is missing
                if (!window.google || !window.google.maps || !window.google.maps.Map) {
                    console.error("Map API loaded but Map constructor is missing (Stub detected).");
                    if (window.gm_authFailure) window.gm_authFailure();
                    return;
                }

                try {
                    const mapEl = document.getElementById(elementId);
                    if (!mapEl) return;
                    mapEl.innerHTML = '';

                    const options = {
                        center: { lat: 39.8283, lng: -98.5795 },
                        zoom: 4,
                        disableDefaultUI: true,
                        styles: [
                             { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                             { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                             { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                             { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                             { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
                             { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }
                        ]
                    };

                    const map = new google.maps.Map(mapEl, options);
                    
                    if (elementId === 'public-map') AppState.publicMap = map;
                    else if (elementId === 'public-driver-map') {
                        AppState.publicDriverMap = map;
                        AppState.maps.personalRouteRenderer = new google.maps.DirectionsRenderer({
                            map: map, suppressMarkers: true, polylineOptions: { strokeColor: '#60a5fa', strokeWeight: 5 }
                        });
                    } else AppState.map = map;
                    
                    // Init services
                    if (google.maps.DirectionsService) {
                        AppState.services.directions = new google.maps.DirectionsService();
                    }

                    this.setupAutocomplete();

                } catch (e) {
                    console.error("Map Component Load Error:", e);
                }
            },

            attachAutocomplete(el) {
                // Safe access using optional chaining to prevent crashes if library is missing
                if (el && window.google?.maps?.places?.Autocomplete) {
                    const ac = new google.maps.places.Autocomplete(el, { fields: ["geometry", "name"], strictBounds: false });
                    AppState.ui.autocomplete.push(ac);
                }
            },

            setupAutocomplete() {
                const inputs = ['job-origin-input', 'location-share-destination'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    this.attachAutocomplete(el);
                });
            },

            renderObjects() {
                if (!AppState.map || !AppState.currentUser) return;
                
                // 1. Render Drivers
                const fiveMinAgo = Date.now() - (5 * 60 * 1000);
                const recent = AppState.activeDrivers.filter(d => d.timestamp && d.timestamp.toMillis() > fiveMinAgo);
                
                // Clear old markers
                for (const id in AppState.driverMapMarkers) {
                    if (!recent.find(d => d.id === id)) {
                        AppState.driverMapMarkers[id].setMap(null);
                        delete AppState.driverMapMarkers[id];
                    }
                }

                if (AppState.isDispatchView) {
                    recent.forEach(d => {
                        if (d.id === AppState.currentUser.id) return;
                        const pos = { lat: d.location.latitude, lng: d.location.longitude };
                        if (AppState.driverMapMarkers[d.id]) {
                            AppState.driverMapMarkers[d.id].setPosition(pos);
                        } else {
                            AppState.driverMapMarkers[d.id] = new google.maps.Marker({
                                position: pos, map: AppState.map,
                                label: { text: (d.name||'D').substring(0,2).toUpperCase(), color: "white", fontWeight: 'bold' },
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: '#f39c12', fillOpacity: 1, strokeColor: 'black', strokeWeight: 2 }
                            });
                        }
                    });
                }

                // 2. Render Routes
                let relevantJobs = AppState.isDispatchView 
                    ? AppState.allJobs.filter(j => j.status === 'in-progress')
                    : AppState.allJobs.filter(j => j.status === 'in-progress' && j.assignedDrivers.some(d => d.id === AppState.currentUser.id));
                
                // Add selected job if not already there (Force render logic)
                if (AppState.selectedJobId) {
                     const selected = AppState.allJobs.find(j => j.id === AppState.selectedJobId);
                     // Avoid duplications if it's already in relevantJobs
                     if (selected && !relevantJobs.find(j => j.id === selected.id)) {
                         relevantJobs = [...relevantJobs, selected];
                     }
                }

                const jobIds = new Set(relevantJobs.map(j => j.id));
                
                // Cleanup routes
                for (const id in AppState.maps.jobRouteRenderers) {
                    if (!jobIds.has(id)) {
                        AppState.maps.jobRouteRenderers[id].setMap(null);
                        delete AppState.maps.jobRouteRenderers[id];
                    }
                }

                relevantJobs.forEach(job => this.drawRoute(job, recent));
            },

            drawRoute(job, drivers) {
                if (!AppState.services.directions) return;
                
                let renderer = AppState.maps.jobRouteRenderers[job.id];
                if (!renderer) {
                    if (google.maps.DirectionsRenderer) {
                        renderer = new google.maps.DirectionsRenderer({
                            map: AppState.map, suppressMarkers: true, preserveViewport: true,
                            polylineOptions: { strokeColor: Utils.getJobColor(job.id), strokeWeight: 5, strokeOpacity: 0.8 }
                        });
                        AppState.maps.jobRouteRenderers[job.id] = renderer;
                    }
                }

                if (!renderer) return;

                // Determine origin: Driver location or Job origin
                const driverId = AppState.isDispatchView ? (job.assignedDrivers?.[0]?.id) : AppState.currentUser.id;
                const driver = drivers.find(d => d.id === driverId);
                const origin = driver ? { lat: driver.location.latitude, lng: driver.location.longitude } : job.origin;
                
                const dests = job.destinations || [job.destination];
                if (!dests || dests.length === 0 || !dests[0]) return; // Skip invalid routes

                const finalDest = dests[dests.length - 1];
                const waypoints = dests.slice(0, -1).map(d => ({ location: d, stopover: true }));

                // Feature: Route Optimization Logic
                const shouldOptimize = job.optimizeRoute === true;

                AppState.services.directions.route({
                    origin: origin, destination: finalDest, waypoints: waypoints,
                    optimizeWaypoints: shouldOptimize, // Use saved preference
                    travelMode: google.maps.TravelMode.DRIVING
                }, (response, status) => {
                    if (status === 'OK') {
                        renderer.setDirections(response);
                        const leg = response.routes[0].legs[0]; // Simplification
                        const etaEl = document.getElementById(`job-eta-info-${job.id}`);
                        if (etaEl) etaEl.innerHTML = `<span>Dist: ${leg.distance.text}</span> | <span>ETA: ${leg.duration.text}</span>`;
                        
                        // Check arrival
                        if (!AppState.isDispatchView && leg.distance.value <= 200) {
                            const btn = document.getElementById('arrived-btn');
                            if(btn) {
                                btn.classList.remove('hidden');
                                btn.dataset.jobId = job.id;
                            }
                        }
                        
                        // --- Feature: Store Optimized Route Order ---
                         if (shouldOptimize && response.routes.length > 0) {
                            const route = response.routes[0];
                            const waypointOrder = route.waypoint_order; // Array of indices [2, 0, 1]
                            
                            // Original waypoints passed to API (excluding final dest)
                            // dests includes the final destination at the end
                            const intermediateDests = dests.slice(0, -1); 
                            
                            // Reorder the intermediate destinations based on the API response
                            const optimizedWaypoints = waypointOrder.map(index => intermediateDests[index]);
                            
                            // Combine: [Optimized Intermediates] + [Final Destination]
                            const fullOptimizedList = [...optimizedWaypoints, finalDest];
                            
                            // Save to State
                            AppState.optimizedRoutes[job.id] = fullOptimizedList;
                        }
                    }
                });
            },

            // New Function: Focus Map on specific Job
            focusOnJob(jobId) {
                const job = AppState.allJobs.find(j => j.id === jobId);
                if (!job) return;

                // Ensure it is rendered (renderObjects handles adding it if we set selectedJobId first)
                // We check if renderer exists. If not, renderObjects needs to run or drawRoute called manually.
                // Since we call renderObjects() in selectJob, we wait for the renderer.
                
                // Hack: Small timeout to allow renderObjects to create the renderer if it wasn't there
                setTimeout(() => {
                    const renderer = AppState.maps.jobRouteRenderers[jobId];
                    if (renderer && renderer.getDirections()) {
                        const result = renderer.getDirections();
                        if (result.routes && result.routes.length > 0) {
                            AppState.map.fitBounds(result.routes[0].bounds);
                        }
                    } else {
                        // Force draw if renderer exists but directions aren't loaded yet (handled by drawRoute logic usually)
                        // Or wait for drawRoute callback.
                        // For simplicity in this version, if drawRoute hasn't finished, fitBounds won't happen immediately.
                        // A production fix would promisify drawRoute.
                    }
                }, 500); 
            }
        };

        // --- AUTH & DATA MODULE ---
        const Data = {
            async initFirebase() {
                const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : CONSTANTS.FIREBASE_CONFIG;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                try {
                    const app = initializeApp(config);
                    AppState.services.auth = getAuth(app);
                    // Updated Persistence for SDK 11.6.1
                    AppState.services.db = initializeFirestore(app, {
                        localCache: persistentLocalCache() 
                    });
                    AppState.services.storage = getStorage(app);
                    
                    // Paths
                    const root = `/artifacts/${appId}/public/data`;
                    AppState.paths = {
                        globalUsers: `${root}/users`,
                        companies: `${root}/companies`,
                        publicJobs: `${root}/publicJobs`,
                        publicDrivers: `${root}/publicDrivers`
                    };
                    
                    // Check for public views
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('jobId') && params.get('inviteId')) {
                        App.loadPublicJob(params.get('jobId'));
                    } else if (params.get('driverId') && params.get('inviteId')) {
                        App.loadPublicDriver(params.get('driverId'), params.get('inviteId'));
                    } else {
                        Maps.init(); // Preload maps
                        this.setupAuthListener();
                    }

                } catch (e) {
                    console.error("Firebase Init Failed:", e);
                    UI.els['loading-overlay'].innerHTML = `<p class="text-red-400">Error: ${e.message}</p>`;
                }
            },

            setupAuthListener() {
                let isFirst = true;
                onAuthStateChanged(AppState.services.auth, async (user) => {
                    UI.els['loading-overlay'].classList.add('hidden');
                    if (user) {
                        isFirst = false;
                        await this.handleUserLogin(user);
                    } else if (isFirst) {
                        isFirst = false;
                        // Auto-login logic
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(AppState.services.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(AppState.services.auth);
                        }
                    } else {
                        App.resetSession();
                    }
                });
            },

            async handleUserLogin(user) {
                AppState.unsubscribes.global.forEach(u => u());
                
                const userRef = doc(AppState.services.db, AppState.paths.globalUsers, user.uid);
                const unsub = onSnapshot(userRef, async (snap) => {
                    let data = snap.data();
                    if (!snap.exists()) {
                        data = { email: user.email || user.uid, name: user.displayName || 'User', currentCompanyId: null };
                        await setDoc(userRef, data);
                    }
                    
                    AppState.currentUser = { id: user.uid, ...data };
                    AppState.isAuthReady = true;
                    
                    // Feature: Auto-recover API Key from Profile if LocalStorage was wiped
                    if (data.customApiKey) {
                        const localKey = localStorage.getItem('vecto_maps_api_key');
                        if (localKey !== data.customApiKey) {
                            localStorage.setItem('vecto_maps_api_key', data.customApiKey);
                            // If maps failed to init because key was missing, try again now
                            if (!window.google || !window.google.maps) {
                                Maps.init();
                            }
                        }
                    }
                    
                    UI.els['auth-container'].classList.add('hidden');
                    UI.els['app-container'].classList.remove('hidden');

                    if (data.currentCompanyId) {
                        if (AppState.companyId !== data.currentCompanyId) this.loadCompany(data.currentCompanyId);
                    } else {
                        UI.showModal('company-modal');
                        this.fetchCompanies();
                    }
                });
                AppState.unsubscribes.global.push(unsub);
            },

            async loadCompany(companyId) {
                AppState.unsubscribes.company.forEach(u => u());
                UI.els['sidebar-loader'].style.display = 'flex';
                
                const companyRef = doc(AppState.services.db, AppState.paths.companies, companyId);
                const memberRef = doc(AppState.services.db, `${AppState.paths.companies}/${companyId}/members`, AppState.currentUser.id);

                try {
                    // Check Company Existence
                    const companySnap = await getDoc(companyRef);
                    if (!companySnap.exists()) {
                        throw new Error("Company does not exist");
                    }
                    
                    // Check Membership Existence (Critical for Security Rules)
                    const memberSnap = await getDoc(memberRef);
                    if (!memberSnap.exists()) {
                        // User thinks they are in company, but they aren't in the members list.
                        // This causes permission-denied on collection queries.
                        throw new Error("Membership invalid"); 
                    }

                    // If we get here, we are safe to setup listeners
                    AppState.companyId = companyId;
                    AppState.companyName = companySnap.data().name;
                    document.getElementById('select-company-btn-label').textContent = AppState.companyName;
                    
                    // Define Company Paths
                    const base = `${AppState.paths.companies}/${companyId}`;
                    AppState.paths.members = `${base}/members`;
                    AppState.paths.drivers = `${base}/driverLocations`;
                    AppState.paths.jobs = `${base}/jobs`;

                    // Listeners
                    AppState.unsubscribes.company.push(onSnapshot(memberRef, (s) => {
                        if (s.exists()) {
                            AppState.currentUser.permissions = s.data().permissions;
                            AppState.isDispatchView = Utils.checkPermission('canCreateJob');
                            App.render();
                        }
                        UI.els['sidebar-loader'].style.display = 'none';
                    }));

                    AppState.unsubscribes.company.push(onSnapshot(collection(AppState.services.db, AppState.paths.members), (s) => {
                        AppState.allUsers = s.docs.map(d => ({id: d.id, ...d.data()}));
                    }));

                    AppState.unsubscribes.company.push(onSnapshot(collection(AppState.services.db, AppState.paths.drivers), (s) => {
                        AppState.activeDrivers = s.docs.map(d => ({id: d.id, ...d.data()}));
                        UI.renderDriversList();
                        Maps.renderObjects();
                    }));

                    AppState.unsubscribes.company.push(onSnapshot(query(collection(AppState.services.db, AppState.paths.jobs)), (s) => {
                        AppState.allJobs = s.docs.map(d => ({id: d.id, ...d.data()}));
                        UI.renderJobsList();
                        Maps.renderObjects();
                        App.updateDriverUI();
                    }));

                } catch (e) {
                    console.warn("Resetting company state due to:", e.message);
                    UI.showToast(e.message === "Membership invalid" ? "You have been removed from this company." : "Company unavailable.", "warning");
                    
                    // Reset Global User State
                    const userRef = doc(AppState.services.db, AppState.paths.globalUsers, AppState.currentUser.id);
                    updateDoc(userRef, { currentCompanyId: null }).catch(err => console.error("Failed to reset user:", err));
                    
                    UI.els['sidebar-loader'].style.display = 'none';
                }
            },

            async fetchCompanies() {
                const list = document.getElementById('company-list');
                list.innerHTML = '<li>Loading...</li>';
                const s = await getDocs(query(collection(AppState.services.db, AppState.paths.companies)));
                list.innerHTML = '';
                if(s.empty) list.innerHTML = '<li class="text-gray-500">No companies found.</li>';
                else {
                    s.forEach(d => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-md';
                        li.innerHTML = `<span class="font-semibold text-white">${d.data().name}</span>
                        <button data-id="${d.id}" data-pw="${!!d.data().hasPassword}" class="join-btn px-3 py-1 bg-blue-600 text-sm rounded">Join</button>`;
                        list.appendChild(li);
                    });
                }
            },

            // --- RESTORED LOGIC START ---
            async joinCompany(companyId, password = null) {
                try {
                    const companyRef = doc(AppState.services.db, AppState.paths.companies, companyId);
                    const companyDoc = await getDoc(companyRef);
                    
                    if (!companyDoc.exists()) {
                        UI.showToast("Company not found", "error");
                        return;
                    }
                    
                    const data = companyDoc.data();
                    if (data.hasPassword && data.password !== password) {
                        UI.showToast("Incorrect Password", "error");
                        return;
                    }

                    // 1. Add to members
                    const memberRef = doc(AppState.services.db, `${AppState.paths.companies}/${companyId}/members`, AppState.currentUser.id);
                    await setDoc(memberRef, {
                        name: AppState.currentUser.name,
                        email: AppState.currentUser.email,
                        permissions: { canCreateJob: false, canDeleteJob: false, canManageDrivers: false }
                    });

                    // 2. Update Global User
                    const userRef = doc(AppState.services.db, AppState.paths.globalUsers, AppState.currentUser.id);
                    await updateDoc(userRef, { currentCompanyId: companyId });

                    UI.hideModal('company-modal');
                    UI.hideModal('company-password-modal');
                    UI.showToast(`Joined ${data.name}`, "success");

                } catch (e) {
                    console.error("Join Error:", e);
                    UI.showToast("Failed to join company", "error");
                }
            },

            async createCompany(name, password) {
                try {
                    const companyRef = doc(collection(AppState.services.db, AppState.paths.companies));
                    await setDoc(companyRef, {
                        name: name,
                        hasPassword: !!password,
                        password: password || null,
                        ownerId: AppState.currentUser.id
                    });

                    // 1. Add owner as member with permissions
                    const memberRef = doc(AppState.services.db, `${AppState.paths.companies}/${companyRef.id}/members`, AppState.currentUser.id);
                    await setDoc(memberRef, {
                        name: AppState.currentUser.name,
                        email: AppState.currentUser.email,
                        permissions: { canCreateJob: true, canDeleteJob: true, canManageDrivers: true }
                    });

                    // 2. Update Global User
                    const userRef = doc(AppState.services.db, AppState.paths.globalUsers, AppState.currentUser.id);
                    await updateDoc(userRef, { currentCompanyId: companyRef.id });

                    UI.hideModal('company-modal');
                    UI.showToast("Company Created", "success");
                } catch (e) {
                    console.error("Create Error:", e);
                    UI.showToast("Failed to create company", "error");
                }
            }
            // --- RESTORED LOGIC END ---
        };

        // --- MAIN APP LOGIC ---
        const App = {
            init() {
                // Add global handler for auth failures (ExpiredKeyMapError, etc)
                window.gm_authFailure = () => {
                    console.error("Google Maps Authentication Failure");
                    UI.showToast("Google Maps API Key Invalid or Expired. Please update in Settings.", "error");
                    const mapEl = document.getElementById('map');
                    if (mapEl) mapEl.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-4 text-center">
                        <p class="text-red-400 font-bold mb-2">Map Authentication Failed</p>
                        <p class="text-gray-400 text-sm mb-4">Your API key may be expired or invalid.</p>
                        <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update Key</button>
                    </div>`;
                };

                UI.init();
                Data.initFirebase();
                this.setupEventListeners();
                
                // Offline handling
                window.addEventListener('offline', () => UI.els['offline-banner'].classList.remove('hidden'));
                window.addEventListener('online', () => UI.els['offline-banner'].classList.add('hidden'));
            },

            render() {
                const user = AppState.currentUser;
                document.getElementById('user-welcome').textContent = `Welcome, ${user.name}!`;
                
                const isDispatch = AppState.isDispatchView;
                UI.els['dispatch-ui'].classList.toggle('hidden', !isDispatch);
                UI.els['driver-ui'].classList.toggle('hidden', isDispatch);
                UI.els['admin-badge'].classList.toggle('hidden', !Utils.checkPermission('canManageDrivers'));
                UI.els['admin-controls'].classList.toggle('hidden', !Utils.checkPermission('canManageDrivers'));
                UI.els['management-actions-panel'].classList.toggle('hidden', !isDispatch);

                if (!isDispatch) this.startLocationSharing();
                else this.stopLocationSharing();
            },

            resetSession() {
                AppState.unsubscribes.global.forEach(u => u());
                AppState.unsubscribes.company.forEach(u => u());
                UI.els['app-container'].classList.add('hidden');
                UI.els['auth-container'].classList.remove('hidden');
                this.stopLocationSharing();
            },

            updateDriverUI() {
                if (AppState.isDispatchView) return;
                
                const myJob = AppState.allJobs.find(j => j.status === 'in-progress' && j.assignedDrivers.some(d => d.id === AppState.currentUser.id));
                const currentPanel = document.getElementById('current-job-panel');
                const availablePanel = document.getElementById('available-jobs-panel');
                
                if (myJob) {
                    currentPanel.classList.remove('hidden');
                    availablePanel.classList.add('hidden');
                    document.getElementById('current-job-details').innerHTML = `
                        <p class="font-bold text-white">${myJob.jobName}</p>
                        <p>From: ${myJob.origin}</p>
                        <p>To: ${myJob.destinations?.[myJob.destinations.length-1] || myJob.destination}</p>
                    `;
                    document.getElementById('complete-job-btn').dataset.jobId = myJob.id;
                    const navBtn = document.getElementById('start-navigation-btn');
                    navBtn.dataset.dest = myJob.destinations?.[myJob.destinations.length-1] || myJob.destination;
                    
                    // Disable status change
                    document.getElementById('driver-status-select').disabled = true;
                } else {
                    currentPanel.classList.add('hidden');
                    availablePanel.classList.remove('hidden');
                    document.getElementById('driver-status-select').disabled = false;
                    this.renderAvailableJobs();
                }
            },

            renderAvailableJobs() {
                const list = document.getElementById('available-jobs-list');
                const jobs = AppState.allJobs.filter(j => j.status === 'unassigned' && !j.archived);
                list.innerHTML = jobs.length ? '' : '<li class="text-gray-500">No open jobs.</li>';
                jobs.forEach(j => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-800 p-3 rounded-md cursor-pointer flex justify-between';
                    li.innerHTML = `<div><p class="font-bold">${j.jobName}</p><p class="text-sm text-gray-400">To: ${j.destinations?.[0]||j.destination}</p></div>
                    <button data-id="${j.id}" class="accept-btn bg-green-600 px-3 py-1 text-xs rounded self-center">Accept</button>`;
                    list.appendChild(li);
                });
            },

            startLocationSharing() {
                if (!navigator.geolocation || AppState.locationWatchId) return;
                AppState.locationWatchId = navigator.geolocation.watchPosition(pos => {
                    if (!AppState.companyId) return;
                    const { latitude, longitude } = pos.coords;
                    const myJob = AppState.allJobs.find(j => j.status === 'in-progress' && j.assignedDrivers.some(d => d.id === AppState.currentUser.id));
                    const status = myJob ? 'On Trip' : document.getElementById('driver-status-select').value;

                    setDoc(doc(AppState.services.db, AppState.paths.drivers, AppState.currentUser.id), {
                        location: new GeoPoint(latitude, longitude),
                        timestamp: serverTimestamp(),
                        status,
                        name: AppState.currentUser.name
                    }, { merge: true });
                });
            },

            stopLocationSharing() {
                if (AppState.locationWatchId) navigator.geolocation.clearWatch(AppState.locationWatchId);
                AppState.locationWatchId = null;
            },

            async createJob(e) {
                e.preventDefault();
                const btn = document.getElementById('create-job-submit-btn');
                UI.toggleSpinner(btn, true);

                try {
                    const destInputs = document.querySelectorAll('#destinations-container input');
                    const destinations = Array.from(destInputs).map(i => i.value).filter(v => v);
                    
                    if (destinations.length === 0) throw new Error("Destination required");

                    // Directions API Call to get distance
                    const origin = document.getElementById('job-origin-input').value;
                    // ... (Simplifying directions logic for brevity - assume standard call)
                    
                    const jobData = {
                        jobName: document.getElementById('job-name-input').value,
                        jobDate: document.getElementById('job-date-input').value,
                        origin,
                        destinations,
                        driversNeeded: 1,
                        // Use 'editing-job-id' check to determine if creating new or updating
                        // If editing, we don't set createdAt, status or log here, they are handled separately or preserved
                        // createdAt: serverTimestamp(), 
                        // status: 'unassigned',
                        // archived: false,
                        // log: [{ text: `Created by ${AppState.currentUser.name}`, timestamp: new Date() }]
                        optimizeRoute: document.getElementById('optimize-route-checkbox').checked
                    };
                    
                    const editingId = document.getElementById('editing-job-id').value;

                    if (editingId) {
                         // UPDATE LOGIC
                         jobData.log = arrayUnion({ text: `Updated by ${AppState.currentUser.name}`, timestamp: new Date() });
                         await updateDoc(doc(AppState.services.db, AppState.paths.jobs, editingId), jobData);
                         UI.showToast("Job Updated", "success");
                    } else {
                         // CREATE LOGIC
                         jobData.createdAt = serverTimestamp();
                         jobData.status = 'unassigned';
                         jobData.archived = false;
                         jobData.log = [{ text: `Created by ${AppState.currentUser.name}`, timestamp: new Date() }];
                         
                         const assignedDriverId = document.getElementById('assign-driver-select').value;
                         if (assignedDriverId) {
                            const driver = AppState.allUsers.find(u => u.id === assignedDriverId);
                            jobData.assignedDrivers = [{id: driver.id, name: driver.name }];
                            jobData.status = 'in-progress';
                            jobData.log.push({ text: `Assigned to ${driver.name}`, timestamp: new Date() });
                         }
                         
                         await addDoc(collection(AppState.services.db, AppState.paths.jobs), jobData);
                         UI.showToast("Job Created", "success");
                    }

                    UI.hideModal('create-job-modal');
                } catch (err) {
                    UI.showToast(err.message, "error");
                } finally {
                    UI.toggleSpinner(btn, false);
                }
            },
            
            openJobDetails(jobId) {
                const job = AppState.allJobs.find(j => j.id === jobId);
                if (!job) return;
                
                const modal = document.getElementById('job-details-modal');
                const content = document.getElementById('job-details-content');
                const history = document.getElementById('job-history-log');
                
                // --- Feature: Display Optimized Order ---
                // If we have a cached optimized order, use it. Otherwise fallback to original.
                let displayDestinations = job.destinations || [];
                let isOptimizedDisplay = false;
                
                if (job.optimizeRoute && AppState.optimizedRoutes[job.id]) {
                    displayDestinations = AppState.optimizedRoutes[job.id];
                    isOptimizedDisplay = true;
                }

                let destHtml = `<ol class="list-decimal list-inside ml-2">`;
                displayDestinations.forEach(d => destHtml += `<li>${d}</li>`);
                destHtml += `</ol>`;
                
                if (isOptimizedDisplay) {
                    destHtml += `<span class="ml-2 text-xs text-teal-400">(Optimized Order)</span>`;
                }

                content.innerHTML = `
                    <p><strong>Name:</strong> ${job.jobName}</p>
                    <p><strong>Date:</strong> ${job.jobDate}</p>
                    <p><strong>Status:</strong> ${job.status}</p>
                    <p><strong>Origin:</strong> ${job.origin}</p>
                    <p><strong>Destinations:</strong></p>${destHtml}
                    <p><strong>Contact:</strong> ${job.contactName || 'N/A'} (${job.contactNumber || 'N/A'})</p>
                    <p class="italic mt-2 text-gray-400">${job.note || 'No notes'}</p>
                `;
                
                // Populate History
                history.innerHTML = '';
                (job.log || []).sort((a,b) => a.timestamp - b.timestamp).forEach(entry => {
                    const date = entry.timestamp?.toDate ? entry.timestamp.toDate().toLocaleString() : 'Just now';
                    history.innerHTML += `<li class="text-xs text-gray-500">[${date}] ${entry.text}</li>`;
                });
                
                // Button Visibility Logic
                const isDispatch = Utils.checkPermission('canCreateJob');
                const editBtn = document.getElementById('edit-job-btn');
                const archiveBtn = document.getElementById('archive-job-btn');
                const unarchiveBtn = document.getElementById('unarchive-job-modal-btn');
                const deleteBtn = document.getElementById('delete-job-btn');
                const printBtn = document.getElementById('print-job-btn');
                
                // Edit Button
                if (editBtn) {
                    editBtn.classList.toggle('hidden', !isDispatch);
                    editBtn.onclick = () => {
                         UI.hideModal('job-details-modal');
                         App.openJobEditor(jobId);
                    };
                }
                
                // Archive / Unarchive Logic
                if (job.archived) {
                    archiveBtn.classList.add('hidden');
                    if(unarchiveBtn) {
                        unarchiveBtn.classList.remove('hidden');
                        unarchiveBtn.onclick = async () => {
                            await updateDoc(doc(AppState.services.db, AppState.paths.jobs, jobId), { archived: false });
                            UI.showToast("Job Unarchived", "success");
                            UI.hideModal('job-details-modal');
                        };
                    }
                } else {
                    if(unarchiveBtn) unarchiveBtn.classList.add('hidden');
                    if (isDispatch) {
                        archiveBtn.classList.remove('hidden');
                        archiveBtn.onclick = async () => {
                            await updateDoc(doc(AppState.services.db, AppState.paths.jobs, jobId), { archived: true });
                            UI.showToast("Job Archived", "success");
                            UI.hideModal('job-details-modal');
                        };
                    } else {
                        archiveBtn.classList.add('hidden');
                    }
                }

                // Delete Button
                if (deleteBtn) {
                    const canDelete = Utils.checkPermission('canDeleteJob');
                    deleteBtn.classList.toggle('hidden', !canDelete);
                    deleteBtn.onclick = () => {
                        // Use AppState.callbacks instead of UI.callbacks
                        AppState.callbacks.confirm = async () => {
                            await deleteDoc(doc(AppState.services.db, AppState.paths.jobs, jobId));
                            UI.showToast("Job Deleted", "success");
                            UI.hideModal('job-details-modal');
                        };
                        document.getElementById('confirm-modal-title').textContent = "Delete Job?";
                        document.getElementById('confirm-modal-message').textContent = "Are you sure you want to permanently delete this job?";
                        UI.showModal('confirm-modal');
                    };
                }

                // Print Button
                if (printBtn) {
                    printBtn.onclick = () => window.print();
                }

                UI.showModal('job-details-modal');
            },
            
            openJobEditor(jobId) {
                const job = AppState.allJobs.find(j => j.id === jobId);
                if (!job) return;
                
                document.getElementById('create-job-modal-title').textContent = 'Edit Job';
                document.getElementById('editing-job-id').value = job.id;
                document.getElementById('job-name-input').value = job.jobName;
                document.getElementById('job-date-input').value = job.jobDate;
                document.getElementById('job-origin-input').value = job.origin;
                document.getElementById('contact-name-input').value = job.contactName || '';
                document.getElementById('contact-number-input').value = job.contactNumber || '';
                document.getElementById('job-note-input').value = job.note || '';
                
                // Update Optimization Checkbox state from saved job data
                const optCheckbox = document.getElementById('optimize-route-checkbox');
                optCheckbox.checked = !!job.optimizeRoute;

                // Destinations
                const container = document.getElementById('destinations-container');
                container.innerHTML = '';
                const destinations = job.destinations || [];
                
                // Show/Hide Optimize container based on count
                const optimizeContainer = document.getElementById('optimize-route-container');
                if (optimizeContainer) {
                    optimizeContainer.classList.toggle('hidden', destinations.length < 2);
                }

                destinations.forEach(dest => {
                     const div = document.createElement('div');
                     div.innerHTML = `<input type="text" value="${dest}" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white mb-2">`;
                     container.appendChild(div);
                     Maps.attachAutocomplete(div.querySelector('input'));
                });
                
                // Reset submit button state
                const btn = document.getElementById('create-job-submit-btn');
                btn.querySelector('.btn-text').textContent = 'Update';
                
                UI.showModal('create-job-modal');
                UI.refreshFormHighlights('create-job-form'); // Ensure highlight logic runs on open
            },
            
            // NEW FUNCTION: Select Job, Highlight in UI, Focus Map
            selectJob(jobId) {
                 AppState.selectedJobId = jobId;
                 // Instead of nuking the list, just update selection visually
                 UI.updateSelection(); 
                 Maps.focusOnJob(jobId); // Focus map on this job
                 
                 // Refresh renderObjects to ensure specific job is drawn if it wasn't visible
                 Maps.renderObjects();
            },

            setupEventListeners() {
                // ... existing listeners ...
                
                // NEW LISTENERS FOR CLICKABLE CARDS (Separate Click vs DblClick)
                const jobsList = document.getElementById('jobs-list');
                
                // We use event delegation.
                // Click -> Select
                jobsList.onclick = (e) => {
                    const li = e.target.closest('li[data-job-id]');
                    if(li) App.selectJob(li.dataset.jobId);
                };
                
                // DblClick -> Open Info
                jobsList.ondblclick = (e) => {
                    const li = e.target.closest('li[data-job-id]');
                    if(li) App.openJobDetails(li.dataset.jobId);
                };
                
                const currentJobPanel = document.getElementById('current-job-panel');
                currentJobPanel.onclick = (e) => {
                     if (e.target.tagName === 'BUTTON') return;
                     const myJob = AppState.allJobs.find(j => j.status === 'in-progress' && j.assignedDrivers.some(d => d.id === AppState.currentUser.id));
                     if(myJob) App.selectJob(myJob.id);
                };
                currentJobPanel.ondblclick = (e) => {
                     if (e.target.tagName === 'BUTTON') return;
                     const myJob = AppState.allJobs.find(j => j.status === 'in-progress' && j.assignedDrivers.some(d => d.id === AppState.currentUser.id));
                     if(myJob) App.openJobDetails(myJob.id);
                };
                
                // Auth
                document.getElementById('google-signin-btn').onclick = async () => {
                    try {
                        await signInWithPopup(AppState.services.auth, new GoogleAuthProvider());
                    } catch (error) {
                        console.error("Sign-in error:", error);
                        if (error.code === 'auth/unauthorized-domain' || error.code === 'auth/operation-not-allowed') {
                            UI.showToast("Domain not authorized for Google Sign-In. Falling back to Guest Mode.", "warning");
                            try {
                                await signInAnonymously(AppState.services.auth);
                            } catch (anonError) {
                                UI.showToast("Guest login failed: " + anonError.message, "error");
                            }
                        } else {
                            UI.showToast("Sign-in failed: " + error.message, "error");
                        }
                    }
                };
                document.getElementById('logout-btn').onclick = () => signOut(AppState.services.auth);

                // Modals
                // Feature: Pre-fill Custom API Key
                document.getElementById('settings-btn').onclick = () => {
                    document.getElementById('custom-api-key-input').value = localStorage.getItem('vecto_maps_api_key') || '';
                    UI.showModal('settings-modal');
                    // Add highlights to API key input
                    UI.setupInputHighlights('settings-modal');
                };
                
                // Feature: Save API Key Listener
                document.getElementById('save-api-key-btn').onclick = async () => {
                    const btn = document.getElementById('save-api-key-btn');
                    btn.disabled = true;
                    btn.textContent = 'Saving...';
                    
                    const key = document.getElementById('custom-api-key-input').value.trim();
                    if (key) {
                        localStorage.setItem('vecto_maps_api_key', key);
                        // Feature: Sync key to Firestore for persistence across reloads/sessions
                        if (AppState.currentUser) {
                             const userRef = doc(AppState.services.db, AppState.paths.globalUsers, AppState.currentUser.id);
                             await updateDoc(userRef, { customApiKey: key }).catch(e => console.log("Failed to sync key:", e));
                        }
                        UI.showToast("API Key Saved. Reloading...", "success");
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        localStorage.removeItem('vecto_maps_api_key');
                        // Also remove from Firestore
                        if (AppState.currentUser) {
                             const userRef = doc(AppState.services.db, AppState.paths.globalUsers, AppState.currentUser.id);
                             await updateDoc(userRef, { customApiKey: deleteField() }).catch(() => {});
                        }
                        UI.showToast("API Key Removed. Reloading...", "success");
                        setTimeout(() => window.location.reload(), 1000);
                    }
                };

                document.getElementById('settings-cancel-btn').onclick = () => UI.hideModal('settings-modal');
                document.getElementById('open-create-job-modal-btn').onclick = () => {
                    document.getElementById('create-job-modal-title').textContent = 'Create New Job';
                    document.getElementById('editing-job-id').value = '';
                    document.getElementById('create-job-form').reset();
                    document.getElementById('destinations-container').innerHTML = '';
                    document.getElementById('create-job-submit-btn').querySelector('.btn-text').textContent = 'Add';
                    UI.showModal('create-job-modal');
                    UI.refreshFormHighlights('create-job-form');
                };
                document.getElementById('create-job-cancel-btn').onclick = () => UI.hideModal('create-job-modal');
                
                // Job Forms
                document.getElementById('create-job-form').onsubmit = (e) => this.createJob(e);
                
                // Feature: Highlight Delegation for Create Job Form
                // We use setupInputHighlights helper for others now
                UI.setupInputHighlights('create-job-form');

                // Company Forms (RESTORED)
                document.getElementById('create-company-form').onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('new-company-name').value.trim();
                    const pw = document.getElementById('new-company-password').value.trim();
                    if(name) Data.createCompany(name, pw);
                };

                document.getElementById('company-password-form').onsubmit = (e) => {
                    e.preventDefault();
                    const pw = document.getElementById('company-password-input').value.trim();
                    Data.joinCompany(AppState.ui.passwordJoinId, pw);
                };
                
                document.getElementById('company-password-cancel-btn').onclick = () => UI.hideModal('company-password-modal');
                document.getElementById('company-cancel-btn').onclick = () => {
                    if (!AppState.companyId) UI.showToast("Please select a company", "error");
                    else UI.hideModal('company-modal');
                };
                
                // Job Details Close
                document.getElementById('job-details-close-btn').onclick = () => UI.hideModal('job-details-modal');

                // Navigation
                document.getElementById('start-navigation-btn').onclick = (e) => {
                    const dest = e.target.dataset.dest;
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=driving`, '_blank');
                };

                // Dynamic Clicks
                document.getElementById('company-list').onclick = (e) => {
                    if (e.target.classList.contains('join-btn')) {
                        const { id, pw } = e.target.dataset;
                        if (pw === 'true') {
                            AppState.ui.passwordJoinId = id;
                            document.getElementById('company-password-form').reset();
                            UI.showModal('company-password-modal');
                            UI.setupInputHighlights('company-password-modal');
                        } else {
                            // Call Data.joinCompany instead of loadCompany
                            Data.joinCompany(id); 
                        }
                    }
                };
                
                // --- NEW LISTENER FOR COMPANY SWITCHING ---
                document.getElementById('select-company-btn').onclick = () => {
                    Data.fetchCompanies();
                    UI.showModal('company-modal');
                    // Add highlights
                    UI.setupInputHighlights('company-modal');
                };

                document.getElementById('available-jobs-list').onclick = async (e) => {
                    if (e.target.classList.contains('accept-btn')) {
                        const id = e.target.dataset.id;
                        await runTransaction(AppState.services.db, async (t) => {
                            const ref = doc(AppState.services.db, AppState.paths.jobs, id);
                            const d = (await t.get(ref)).data();
                            t.update(ref, {
                                status: 'in-progress',
                                assignedDrivers: arrayUnion({id: AppState.currentUser.id, name: AppState.currentUser.name})
                            });
                        });
                        UI.showToast("Job Accepted!", "success");
                    }
                };

                // Add Destination Input Logic
                document.getElementById('add-destination-btn').onclick = () => {
                   const container = document.getElementById('destinations-container');
                   const div = document.createElement('div');
                   div.innerHTML = `<input type="text" placeholder="Destination" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white mb-2 soft-teal-glow">`;
                   container.appendChild(div);
                   
                   // Toggle Optimize Checkbox visibility
                   const count = container.querySelectorAll('input').length;
                   const optimizeContainer = document.getElementById('optimize-route-container');
                   if (optimizeContainer) {
                        optimizeContainer.classList.toggle('hidden', count < 2);
                   }
                   
                   // Attach the autocomplete!
                   Maps.attachAutocomplete(div.querySelector('input'));
                };
                
                // Confirm Modal
                document.getElementById('confirm-cancel-btn').onclick = () => {
                    UI.hideModal('confirm-modal');
                    AppState.callbacks.confirm = null;
                };
                document.getElementById('confirm-action-btn').onclick = () => {
                    if(AppState.callbacks.confirm) AppState.callbacks.confirm();
                    UI.hideModal('confirm-modal');
                    AppState.callbacks.confirm = null;
                };

                // Settings Listeners
                document.getElementById('open-profile-modal-btn').onclick = () => {
                    UI.hideModal('settings-modal');
                    document.getElementById('profile-name-input').value = AppState.currentUser?.name || '';
                    document.getElementById('profile-phone-input').value = AppState.currentUser?.phone || '';
                    UI.showModal('profile-modal');
                    UI.setupInputHighlights('profile-modal');
                };
                
                document.getElementById('profile-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('profile-name-input').value.trim();
                    const phone = document.getElementById('profile-phone-input').value.trim();
                    if(name) {
                        await updateDoc(doc(AppState.services.db, AppState.paths.globalUsers, AppState.currentUser.id), { name, phone });
                        await updateDoc(doc(AppState.services.db, AppState.paths.members, AppState.currentUser.id), { name, phone });
                        UI.showToast("Profile Updated", "success");
                        UI.hideModal('profile-modal');
                    }
                };
                document.getElementById('profile-cancel-btn').onclick = () => UI.hideModal('profile-modal');

                document.getElementById('open-user-guide-btn').onclick = () => {
                    UI.hideModal('settings-modal');
                    UI.showModal('user-guide-modal');
                };
                document.getElementById('user-guide-close-btn').onclick = () => UI.hideModal('user-guide-modal');

                document.getElementById('open-invite-modal-btn').onclick = () => {
                    if (!AppState.companyId) {
                        UI.showToast("Please join a company first.", "error");
                        return;
                    }
                    UI.hideModal('settings-modal');
                    const url = Utils.generateInviteLink();
                    document.getElementById('share-link-input').value = url;
                    const qrEl = document.getElementById('qrcode');
                    qrEl.innerHTML = '';
                    new QRCode(qrEl, { text: url, width: 128, height: 128 });
                    UI.showModal('invite-modal');
                };
                document.getElementById('invite-cancel-btn').onclick = () => UI.hideModal('invite-modal');
                document.getElementById('copy-link-btn').onclick = () => {
                    document.getElementById('share-link-input').select();
                    document.execCommand('copy');
                    UI.showToast("Link Copied", "success");
                };

                document.getElementById('open-admin-settings-btn').onclick = () => {
                    UI.hideModal('settings-modal');
                    UI.renderUserRoles();
                    UI.showModal('admin-settings-modal');
                };
                document.getElementById('admin-settings-cancel-btn').onclick = () => UI.hideModal('admin-settings-modal');
                document.getElementById('refresh-user-roles-btn').onclick = () => UI.renderUserRoles();
                
                // Event Delegation for Role List
                document.getElementById('user-role-list').onclick = async (e) => {
                    if(e.target.classList.contains('perm-check')) {
                        const { uid, perm } = e.target.dataset;
                        const checked = e.target.checked;
                        try {
                           await updateDoc(doc(AppState.services.db, `${AppState.paths.companies}/${AppState.companyId}/members`, uid), { [`permissions.${perm}`]: checked });
                           UI.showToast("Permissions Updated", "success");
                        } catch(err) {
                           UI.showToast("Update Failed", "error");
                           e.target.checked = !checked;
                        }
                    }
                    const btn = e.target.closest('.delete-user-btn');
                    if(btn) {
                        const uid = btn.dataset.userId;
                        UI.callbacks.confirm = async () => {
                            await deleteDoc(doc(AppState.services.db, `${AppState.paths.companies}/${AppState.companyId}/members`, uid));
                            await updateDoc(doc(AppState.services.db, AppState.paths.globalUsers, uid), { currentCompanyId: null });
                            UI.showToast("User Removed", "success");
                            UI.renderUserRoles(); 
                        };
                        document.getElementById('confirm-modal-title').textContent = "Remove User?";
                        document.getElementById('confirm-modal-message').textContent = "This will remove the user from the company.";
                        UI.showModal('confirm-modal');
                    }
                };
            },

            loadPublicJob(jobId) { /* Logic for Public Job View */ },
            loadPublicDriver(driverId, token) { /* Logic for Public Driver View */ }
        };

        // --- BOOTSTRAP ---
        window.onload = () => App.init();
    </script>
    <!-- === JAVASCRIPT END === -->
</body>
</html>
